<html>
  <head>
    <title>Three.js Crash</title>

    <style>
      body {
        width: 100%;
        height: 100%;
        background-color: rgba(1, 1, 1, 1);
      }
      #overlay {
        position: absolute;
        width: 100%;
        height: 100%;
        background-color: rgba(1, 0, 0, 0.5);
      }
      #pause {
        width: 100%;
        height: 100%;

        display: -webkit-box;
        display: -moz-box;
        display: box;

        -webkit-box-orient: horizontal;
        -moz-box-orient: horizontal;
        box-orient: horizontal;

        -webkit-box-pack: center;
        -moz-box-pack: center;
        box-pack: center;

        -webkit-box-align: center;
        -moz-box-align: center;
        box-align: center;

        color: #ffffff;
        text-align: center;

        cursor: pointer;
      }
    </style>
  </head>

  <body>
    <div id="overlay">
      <div id="pause">
        <span style="font-size:30px">PAUSE</span>
      </div>
    </div>

    <script src="js/three.js"></script>
    <script src="js/OrbitControls.js"></script>
    <script src="js/PointerLockControls.js"></script>

    <script>
      var scene, camera, controls, renderer;
      var objects = [];

      var raycaster;

      var overlay = document.getElementById('overlay');
      var pause = document.getElementById('pause');

      var pointerLock = 'pointerLockElement' in document || 'mozPointerLockElement' in document || 'webkitPointerLockElement' in document;

      if(pointerLock) {
        var element = document.body;

        var pointerLockChange = function (event) {
          if(document.pointerLockElement === element || document.mozPointerLockElement === element || document.webkitPointerLockElement === element) {
            enableControls = true;
            controls.enabled = true;
            overlay.style.display = 'none';
          } else {
            controls.enabled = false;
            overlay.style.display = 'block';
            pause.style.display = '';
          }
        };

        var pointerLockError = function (event) {
          pause.style.display = '';
        }

        var pauseClickEvent = function (event) {
          pause.style.display = 'none';
          element.requestPointerLock = element.requestPointerLock || element.mozRequestPointerLock || element.webkitRequestPointerLock;
          element.requestPointerLock();
        }

        document.addEventListener('pointerlockchange', pointerLockChange, false);
        document.addEventListener('mozpointerlockchange', pointerLockChange, false);
        document.addEventListener('webkitpointerlockchange', pointerLockChange, false);

        document.addEventListener('pointerlockerror', pointerLockError, false);
        document.addEventListener('mozpointerlockerror', pointerLockError, false);
        document.addEventListener('webkitpointerlockerror', pointerLockError, false);

        pause.addEventListener('click', pauseClickEvent, false);
      } else {
        pause.innerHTML = 'Browser does not support Pointer Lock API';
      }

      var enableControls = false;
      var move_forward = false;
      var move_backward = false;
      var move_left = false;
      var move_right = false;
      var move_jump = false;

      var dTime = performance.now();
      var velocity = new THREE.Vector3();
      var direction = new THREE.Vector3();
      var vertex = new THREE.Vector3();
      var color = new THREE.Vector3();

      start();
      //update();

      function start() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);

        // --- Controls --- //
        controls = new THREE.PointerLockControls(camera);
        scene.add(controls.getObject());

        var onKeyDown = function(event) {
          switch(event.keyCode) {
            case 87: move_forward = true; break;
            case 83: move_backward = true; break;
            case 65: move_left = true; break;
            case 68: move_right = true; break;
            case 32: if(move_jump === true) velocity.y += 300; move_jump = false; break;
          }
        };

        var onKeyUp = function(event) {
          switch(event.keyCode) {
            case 87: move_forward = false; break;
            case 83: move_backward = false; break;
            case 65: move_left = false; break;
            case 68: move_right = false; break;
          }
        };

        document.addEventListener('keydown', onKeyDown, false);
        document.addEventListener('keyup', onKeyUp, false);
        // ---------------- //

        raycaster = new THREE.Raycaster(new THREE.Vector3(), new THREE.Vector3(0, -1, 0), 0, 10);

        // --- Floor Object --- //
        var floorGeometry = new THREE.PlaneBufferGeometry(100, 100, 10, 10);
        floorGeometry.rotateX(-Math.PI / 2);

        var position = floorGeometry.attributes.position;
        for ( var i = 0; i < position.count; i ++ ) {
          vertex.fromBufferAttribute( position, i );
          vertex.x += Math.random() * 20 - 10;
          vertex.y += Math.random() * 2;
          vertex.z += Math.random() * 20 - 10;
          position.setXYZ( i, vertex.x, vertex.y, vertex.z );
        }
        floorGeometry = floorGeometry.toNonIndexed(); // ensure each face has unique vertices
        count = floorGeometry.attributes.position.count;
        var colors = [];
        for ( var i = 0; i < count; i ++ ) {
          color.setHSL( Math.random() * 0.3 + 0.5, 0.75, Math.random() * 0.25 + 0.75 );
          colors.push( color.r, color.g, color.b );
        }
        floorGeometry.addAttribute( 'color', new THREE.Float32BufferAttribute( colors, 3 ) );
        
        var floorMaterial = new THREE.MeshBasicMaterial({vertexColors: THREE.VertexColors});
        var floor = new THREE.Mesh(floorGeometry, floorMaterial);
        scene.add(floor);
        // -------------------- //
      }





    /*
      var scene = new THREE.Scene();
      var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);

      var renderer = new THREE.WebGLRenderer();
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      window.addEventListener('resize', function() {
        var width = window.innerWidth;
        var height = window.innerHeight;
        renderer.setSize(width, height);
        camera.aspect = width / height;
        camera.updateProjectionMatrix();
      });

      //controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls = new THREE.FirstPersonControls(camera, renderer.domElement);

      var geometry = new THREE.BoxGeometry(1, 1, 1);

      var material = new THREE.MeshBasicMaterial({color: 0xFFFFFF, wireframe: true});
      var cube = new THREE.Mesh(geometry, material);
      scene.add(cube);

      camera.position.z = 3;

      var update = function() {
        cube.rotation.x += 0.01;
        cube.rotation.y += 0.005;
      };

      var render = function() {
        renderer.render(scene, camera);
      };

      var GameLoop = function() {
        requestAnimationFrame(GameLoop);

        update();
        render();
      };

      GameLoop();
    */
    </script>
  </body>
</html>